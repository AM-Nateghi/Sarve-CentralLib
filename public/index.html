<!doctype html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="utf-8" />
    <title>سیستم ضدکخ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Anti-Kokh" />
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%232c3e50'/%3E%3Ctext x='32' y='40' font-size='26' text-anchor='middle' fill='white' font-family='Arial'%3EAK%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jalalidate@latest/dist/jalalidate.min.js"></script>
    <script src="https://cdn.kavenegar.com/sdk/page.js?appId=0ecfa240-c40d-43dd-8c85-95aa540c5feb" defer
        charset="utf-8"></script>
    <link rel="stylesheet" href="style.css" />
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800 overflow-x-hidden">
    <div class="min-h-screen">
        <div class="container max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Header -->
            <header class="text-center mb-8 pt-4">
                <h1
                    class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent leading-tight">
                    سیستم ضدکخ</h1>
                <p class="text-slate-500 mt-2 text-sm sm:text-base">رزرو هوشمند صندلی کتابخانه</p>
            </header>

            <!-- Main cards grid -->
            <div class="grid gap-6 mb-10">
                <!-- Config card -->
                <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-100 p-6 space-y-5">
                    <div class="flex items-center justify-between pb-3 border-b border-slate-100">
                        <h2 class="text-lg sm:text-xl font-bold">⚙️ تنظیمات</h2>
                        <button id="openSettingsBtn"
                            class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition text-xl"
                            aria-label="باز کردن تنظیمات پیشرفته">🔧</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                            <p class="text-xs text-slate-500 mb-1">شماره صندلی</p>
                            <p id="seatDisplay" class="text-lg sm:text-2xl font-bold text-indigo-600">—</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                            <p class="text-xs text-slate-500 mb-1">حالت تاریخ</p>
                            <p id="dateModeDisplay" class="text-lg sm:text-2xl font-bold text-purple-600">—</p>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-semibold mb-3 block">بازه‌های زمانی:</label>
                        <div id="windowsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                            <!-- Checkboxes injected here -->
                        </div>
                    </div>

                    <div class="flex gap-3 main-actions flex-col sm:flex-row">
                        <button id="reserveNowBtn"
                            class="flex-1 rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 font-bold hover:shadow-lg transition transform hover:scale-[1.01] active:scale-95">
                            🚀 رزرو فوری
                        </button>
                        <button id="customScheduleBtn"
                            class="flex-1 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-600 text-white py-3 font-bold hover:shadow-lg transition transform hover:scale-[1.01] active:scale-95">
                            ⏰ زمان‌بندی دلخواه
                        </button>
                        <button id="saveConfigBtn"
                            class="rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-900 px-5 py-3 font-semibold transition border border-slate-200">
                            💾 ذخیره
                        </button>
                    </div>
                </section>

                <!-- Quota and quota info -->
                <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-100 p-6">
                    <h3 class="font-bold mb-3">📊 وضعیت سهم</h3>
                    <p id="quotaDisplay"
                        class="text-sm text-slate-600 p-3 bg-slate-50 rounded-lg border border-slate-100">در حال
                        بارگذاری...
                    </p>
                </section>

                <!-- Custom Schedules Section -->
                <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-100 p-6 space-y-4">
                    <div class="flex items-center justify-between mb-2 pb-3 border-b border-slate-100">
                        <h2 class="text-lg sm:text-xl font-bold">⏰ زمان‌بندی‌های دلخواه</h2>
                        <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">زمان‌بندی‌های ثبت
                            شده</span>
                    </div>
                    <div id="customSchedulesContainer" class="space-y-3">
                        <p class="text-sm text-slate-500 text-center py-4">هیچ زمان‌بندی دلخواهی ثبت نشده است</p>
                    </div>
                </section>

                <!-- Week preview -->
                <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-100 p-6 space-y-4">
                    <div class="flex items-center justify-between mb-2 pb-3 border-b border-slate-100">
                        <h2 class="text-lg sm:text-xl font-bold">📅 جدول هفتگی</h2>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">تا ۱۰ روز
                            آینده</span>
                    </div>
                    <div class="hidden sm:block overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-200">
                                    <th class="text-right py-3 font-semibold text-slate-700">تاریخ</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">بازه‌ها</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">وضعیت</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="weekTableBody" class="divide-y divide-slate-100">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="weekCards" class="grid sm:hidden gap-3"></div>
                </section>

                <!-- History Section -->
                <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-100 p-6 space-y-4">
                    <div class="flex items-center justify-between mb-2 pb-3 border-b border-slate-100">
                        <h2 class="text-lg sm:text-xl font-bold">📋 تاریخچه رزروها</h2>
                        <div class="flex items-center gap-2">
                            <span class="hidden sm:inline text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded-full">۵۰
                                ورودی اخیر</span>
                            <button id="toggleHistoryBtn"
                                class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-700 hover:bg-slate-200 transition"
                                type="button" aria-expanded="false">نمایش بیشتر</button>
                        </div>
                    </div>
                    <div id="historyWrapper"
                        class="hidden sm:block overflow-x-auto max-h-80 overflow-y-auto rounded-xl border border-slate-100">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-200">
                                    <th class="text-right py-3 font-semibold text-slate-700">تاریخ</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">بازه</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">وضعیت</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">پیام</th>
                                    <th class="text-right py-3 font-semibold text-slate-700">زمان</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-slate-100">
                                <!-- History entries injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="historyCards" class="sm:hidden grid gap-3 max-h-80 overflow-y-auto"></div>
                    <p id="historyEmpty" class="text-center text-slate-500 py-6 text-sm">هیچ رزروی ثبت نشده است</p>
                </section>
            </div>
        </div>
    </div>
    <div id="settingsModal"
        class="fixed inset-0 modal-backdrop opacity-0 pointer-events-none transition-opacity z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold">⚙️ تنظیمات پیشرفته</h2>
                <button id="closeSettingsBtn" class="text-2xl text-slate-400 hover:text-slate-600">✕</button>
            </div>

            <div class="p-6 space-y-6">
                <!-- Username -->
                <div>
                    <label class="text-sm font-semibold block mb-2">نام کاربری (شماره تلفن)</label>
                    <input id="usernameInput" type="text"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="0928731571">
                </div>

                <!-- Password -->
                <div>
                    <label class="text-sm font-semibold block mb-2">رمز عبور</label>
                    <input id="passwordInput" type="password"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="••••••••">
                </div>

                <!-- Seat Number -->
                <div>
                    <label class="text-sm font-semibold block mb-2">شماره صندلی</label>
                    <input id="seatNumberInput" type="number"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="33">
                </div>

                <!-- Seat Priority List -->
                <div>
                    <label class="text-sm font-semibold block mb-2">ترتیب اولویت صندلی‌ها (با کاما جدا شده)</label>
                    <input id="seatPriorityInput" type="text"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                        placeholder="33,32,34,37,42">
                    <p class="text-xs text-slate-500 mt-1">اولا ۳۳ تلاش می‌شود، بعد ۳۲، و...تا هرچیزی موجود شود</p>
                </div>

                <!-- Concurrency and spread -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm font-semibold block mb-2">Concurrency (همزمانی)</label>
                        <input id="concurrencyInput" type="number" min="1" max="8" value="3"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="3">
                        <p class="text-xs text-slate-500 mt-1">تعداد درخواست همزمان پس از لاگین (پیش‌فرض 3)</p>
                    </div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Spread (ms)</label>
                        <input id="requestSpreadInput" type="number" min="0" max="2000" value="400"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="400">
                        <p class="text-xs text-slate-500 mt-1">حداکثر پراکندگی تصادفی شروع درخواست‌ها به میلی‌ثانیه</p>
                    </div>
                </div>

                <!-- Reserve Mode -->
                <div>
                    <label class="text-sm font-semibold block mb-3">حالت رزرو</label>
                    <div class="space-y-2">
                        <label
                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                            <input id="todayRadio" type="radio" name="reserveMode" value="today"
                                class="w-4 h-4 accent-indigo-600">
                            <span>امروز</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                            <input id="tomorrowRadio" type="radio" name="reserveMode" value="tomorrow"
                                class="w-4 h-4 accent-indigo-600">
                            <span>فردا</span>
                        </label>
                    </div>
                </div>

                <!-- Service Code -->
                <div>
                    <label class="text-sm font-semibold block mb-2">کد سرویس (SC)</label>
                    <input id="scInput" type="text"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-xs"
                        placeholder="ktDKKeFZe5lkOhWTITfdmQ==">
                </div>

                <!-- Save Button -->
                <button id="saveSettingsBtn"
                    class="w-full rounded-xl bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 font-bold hover:shadow-lg transition">
                    ✓ ذخیره تنظیمات
                </button>
            </div>
        </div>
    </div>

    <!-- Day Edit Modal -->
    <div id="dayEditModal"
        class="fixed inset-0 modal-backdrop opacity-0 pointer-events-none transition-opacity z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="border-b border-slate-200 p-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold" id="dayEditTitle">ویرایش روز</h2>
                <button id="closeDayEditBtn" class="text-2xl text-slate-400 hover:text-slate-600">✕</button>
            </div>

            <div class="p-6 space-y-4">
                <p class="text-sm text-slate-600">بازه‌های موجود را برای این روز انتخاب کنید:</p>
                <div id="dayEditCheckboxes" class="space-y-2">
                    <!-- Checkboxes injected here -->
                </div>
                <div class="flex gap-3 pt-4">
                    <button id="saveDayEditBtn"
                        class="flex-1 rounded-lg bg-indigo-600 text-white py-2 font-bold hover:bg-indigo-700 transition">
                        ✓ ذخیره
                    </button>
                    <button id="deleteDayEditBtn"
                        class="flex-1 rounded-lg bg-red-100 text-red-700 py-2 font-bold hover:bg-red-200 transition">
                        🗑️ حذف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Schedule Modal -->
    <div id="customScheduleModal"
        class="fixed inset-0 modal-backdrop opacity-0 pointer-events-none transition-opacity z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold">⏰ زمان‌بندی دلخواه</h2>
                <button id="closeCustomScheduleBtn" class="text-2xl text-slate-400 hover:text-slate-600">✕</button>
            </div>

            <div class="p-6 space-y-6">
                <!-- Reserve Date Selection -->
                <div>
                    <label class="text-sm font-semibold block mb-3">تاریخ رزرو (روزی که میخوام رزرو کنم)</label>
                    <p class="text-xs text-slate-500 mb-3">تاریخ مورد نظر برای رزرو صندلی را انتخاب کنید</p>
                    <div id="reserveDateGrid" class="grid grid-cols-3 gap-2"></div>
                </div>

                <!-- Time Windows for Reserve Date -->
                <div>
                    <label class="text-sm font-semibold block mb-3">بازه‌های زمانی</label>
                    <p class="text-xs text-slate-500 mb-3">بازه‌های رزرو برای روز انتخاب شده</p>
                    <div id="scheduleWindowsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                </div>

                <!-- Execution Date & Time -->
                <div class="border-t border-slate-100 pt-6">
                    <label class="text-sm font-semibold block mb-3">زمان اجرا (کی این رزرو رو انجام بده)</label>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-semibold block mb-2">تاریخ اجرا</label>
                            <input id="executionDateInput" type="date"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">تاریخی که سیستم رو فعال میکنید</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-semibold block mb-2">ساعت</label>
                                <input id="executionHourInput" type="number" min="0" max="23"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="07">
                            </div>
                            <div>
                                <label class="text-xs font-semibold block mb-2">دقیقه</label>
                                <input id="executionMinuteInput" type="number" min="0" max="59"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Button -->
                <button id="submitCustomScheduleBtn"
                    class="w-full rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 font-bold hover:shadow-lg transition">
                    ✓ ثبت زمان‌بندی
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="progressToastContainer"
        class="fixed bottom-4 left-0 right-0 mx-auto w-full max-w-sm sm:max-w-md sm:left-4 sm:right-auto px-4 sm:px-0 flex flex-col gap-3 pointer-events-none z-50">
    </div>
    <div id="toast"
        class="fixed bottom-4 left-0 right-0 mx-auto sm:left-auto sm:right-4 max-w-sm bg-slate-900 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity">
        <div id="toastMessage"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="script.js"></script>
</body>

</html>